<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PMO Agent Workspace</title>
    <style>
      :root {
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #1f2933;
        background: #f5f7fa;
      }
      body {
        margin: 0;
        padding: 0;
      }
      header {
        padding: 1rem 1.25rem 0.5rem;
        text-align: center;
      }
      h1 {
        font-size: 1.5rem;
        margin: 0 0 0.5rem;
      }
      main {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        padding: 0 1.25rem 2rem;
        max-width: 960px;
        margin: 0 auto;
      }
      section {
        background: #ffffff;
        border-radius: 0.75rem;
        padding: 1.25rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      }
      .upload-controls {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .upload-controls button,
      .chat-input button {
        background: #2563eb;
        color: #fff;
        border: none;
        padding: 0.75rem 1rem;
        border-radius: 0.6rem;
        font-weight: 600;
        cursor: pointer;
      }
      .upload-controls button:disabled,
      .chat-input button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .preview-area {
        margin-top: 1rem;
        max-height: 260px;
        overflow: auto;
        border: 1px solid #e2e8f0;
        border-radius: 0.65rem;
        padding: 0.75rem;
        background: #f8fafc;
        font-size: 0.9rem;
        white-space: pre-wrap;
      }
      .preview-area table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      .preview-area th,
      .preview-area td {
        border: 1px solid #cbd5e1;
        padding: 0.35rem;
        text-align: left;
      }
      .chat-area {
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }
      .messages {
        border: 1px solid #e2e8f0;
        border-radius: 0.75rem;
        background: #ffffff;
        max-height: 360px;
        overflow-y: auto;
        padding: 1rem;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .bubble {
        border-radius: 0.75rem;
        padding: 0.75rem;
        line-height: 1.45;
      }
      .bubble.user {
        align-self: flex-end;
        background: #2563eb;
        color: #fff;
      }
      .bubble.assistant {
        align-self: flex-start;
        background: #f1f5f9;
        color: #0f172a;
      }
      .chat-input {
        display: flex;
        gap: 0.75rem;
      }
      .chat-input textarea {
        flex: 1;
        border-radius: 0.65rem;
        border: 1px solid #cbd5e1;
        padding: 0.75rem;
        min-height: 80px;
        font-family: inherit;
        resize: vertical;
      }
      .note {
        font-size: 0.85rem;
        color: #475569;
      }
      @media (min-width: 900px) {
        main {
          flex-direction: row;
          align-items: flex-start;
        }
        section {
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>PMO Agent Workspace</h1>
      <p class="note">Upload one file at a time. The latest upload becomes the active context for chat in this browser session.</p>
    </header>
    <main>
      <section>
        <h2>Upload context</h2>
        <div class="upload-controls">
          <input id="file-input" type="file" accept=".txt,.md,.csv,.docx" />
          <button id="upload-btn">Upload &amp; set context</button>
          <div id="upload-status" class="note"></div>
        </div>
        <div id="preview" class="preview-area" hidden></div>
      </section>
      <section>
        <h2>Chat</h2>
        <div class="chat-area">
          <div id="messages" class="messages"></div>
          <form id="chat-form" class="chat-input">
            <textarea id="chat-text" placeholder="Ask about the project..."></textarea>
            <button id="send-btn" type="submit">Send</button>
          </form>
        </div>
      </section>
    </main>
    <script>
      const uploadBtn = document.getElementById("upload-btn");
      const fileInput = document.getElementById("file-input");
      const uploadStatus = document.getElementById("upload-status");
      const preview = document.getElementById("preview");
      const chatForm = document.getElementById("chat-form");
      const chatText = document.getElementById("chat-text");
      const messages = document.getElementById("messages");
      const sendBtn = document.getElementById("send-btn");

      function setUploadStatus(text, isError = false) {
        uploadStatus.textContent = text;
        uploadStatus.style.color = isError ? "#dc2626" : "#475569";
      }

      function showTextPreview(text) {
        preview.hidden = false;
        preview.innerHTML = "";
        const pre = document.createElement("pre");
        pre.textContent = text || "(no preview)";
        preview.appendChild(pre);
      }

      function showCsvPreview(columns, rows) {
        preview.hidden = false;
        preview.innerHTML = "";
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headRow = document.createElement("tr");
        columns.forEach((col) => {
          const th = document.createElement("th");
          th.textContent = col;
          headRow.appendChild(th);
        });
        thead.appendChild(headRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        rows.forEach((row) => {
          const tr = document.createElement("tr");
          row.forEach((cell) => {
            const td = document.createElement("td");
            td.textContent = cell;
            tr.appendChild(td);
          });
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        preview.appendChild(table);
      }

      uploadBtn.addEventListener("click", async () => {
        if (!fileInput.files.length) {
          setUploadStatus("Pick a file before uploading.", true);
          return;
        }
        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        uploadBtn.disabled = true;
        setUploadStatus("Uploading...");

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
            credentials: "include",
          });

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Upload failed");
          }

          setUploadStatus(`Context stored (${data.chars} characters).`);
          if (data.csv_preview) {
            showCsvPreview(data.csv_preview.columns, data.csv_preview.rows);
          } else if (data.text_preview) {
            showTextPreview(data.text_preview);
          } else {
            preview.hidden = true;
          }
        } catch (error) {
          console.error("Upload error", error);
          setUploadStatus(error.message || "Upload failed", true);
          preview.hidden = true;
        } finally {
          uploadBtn.disabled = false;
        }
      });

      function appendMessage(role, content) {
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role}`;
        bubble.textContent = content;
        messages.appendChild(bubble);
        messages.scrollTop = messages.scrollHeight;
      }

      chatForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const text = chatText.value.trim();
        if (!text) {
          return;
        }

        appendMessage("user", text);
        chatText.value = "";
        sendBtn.disabled = true;

        try {
          const response = await fetch("/chat/send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ message: text }),
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "Chat request failed");
          }
          appendMessage("assistant", data.reply);
        } catch (error) {
          console.error("Chat error", error);
          appendMessage("assistant", `⚠️ ${error.message || "Chat failed."}`);
        } finally {
          sendBtn.disabled = false;
          chatText.focus();
        }
      });
    </script>
  </body>
</html>
